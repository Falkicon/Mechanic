<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mechanic Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0f1a;
            --bg-secondary: #111827;
            --bg-tertiary: #1a2332;
            --card: #1e293b;
            --border: #334155;
            --border-light: #475569;
            --primary: #38bdf8;
            --primary-glow: rgba(56, 189, 248, 0.15);
            --success: #4ade80;
            --success-glow: rgba(74, 222, 128, 0.15);
            --error: #f87171;
            --error-glow: rgba(248, 113, 113, 0.15);
            --warning: #fbbf24;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --text-dim: #64748b;
            --mono: 'JetBrains Mono', monospace;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header { 
            padding: 0.625rem 1rem; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: var(--bg-secondary);
        }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .logo { font-size: 1rem; font-weight: 700; color: var(--primary); letter-spacing: -0.025em; }
        .logo span { color: var(--text-dim); font-weight: 400; font-size: 0.7rem; margin-left: 0.375rem; }
        .header-actions { display: flex; gap: 0.5rem; align-items: center; }
        .header-spacer { width: 1px; height: 20px; background: var(--border); margin: 0 0.5rem; }
        .addon-output-btn { font-size: 0.75rem; }
        .addon-output-btn.active { background: var(--primary-glow); border-color: var(--primary); color: var(--primary); }
        .btn-icon-only { padding: 0.375rem 0.5rem; min-width: 36px; justify-content: center; }
        .btn-stop { color: var(--text); background-color: var(--error); border-color: rgba(255, 255, 255, 1); }
        .btn-stop:hover { background: var(--error-glow); }
        
        /* Layout */
        .app-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { 
            width: 200px; 
            background: var(--bg-secondary); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column;
            overflow-y: auto;
        }
        .main-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .content-area { flex: 1; overflow: hidden; padding: 1rem; display: flex; flex-direction: column; }
        .console-area { 
            height: 180px;
            min-height: 180px;
            border-top: 1px solid var(--border); 
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
        }

        /* Buttons */
        .btn { 
            padding: 0.375rem 0.75rem; border-radius: 6px; font-weight: 600; font-size: 0.75rem; 
            cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 0.5rem; border: none;
            font-family: inherit;
        }
        .btn-primary { background: var(--primary); color: var(--bg); }
        .btn-primary:hover { background: #7dd3fc; }
        .btn-run { background: var(--success); color: var(--bg); font-size: 0.8rem; padding: 0.5rem 1rem; }
        .btn-run:hover { background: #86efac; }
        .btn-run.loading { 
            background: var(--primary); 
            cursor: wait; 
            pointer-events: none;
            animation: pulse-loading 1.2s ease-in-out infinite;
        }
        @keyframes pulse-loading {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .btn-danger { background: transparent; color: var(--error); border: 1px solid var(--error); }
        .btn-danger:hover { background: var(--error-glow); }
        .btn-ghost { background: var(--card); color: var(--text); border: 1px solid var(--border); }
        .btn-ghost:hover { border-color: var(--border-light); background: var(--bg-tertiary); }
        .btn-nav { background: var(--card); color: var(--text); border: 1px solid var(--border-light); padding: 0.375rem 0.625rem; font-size: 0.75rem; font-weight: 500; }
        .btn-nav:hover { background: var(--bg-tertiary); border-color: var(--primary); color: var(--primary); }
        .btn-nav:disabled { opacity: 0.3; cursor: not-allowed; background: var(--bg-tertiary); }
        .kbd { font-size: 0.6rem; background: var(--bg); padding: 0.1rem 0.2rem; border-radius: 3px; color: var(--text-dim); margin-left: 0.25rem; }

        /* Addon Selector */
        .addon-context { padding: 0.625rem 0.75rem; border-bottom: 1px solid var(--border); }
        .addon-context-label { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-dim); margin-bottom: 0.25rem; }
        .addon-select-wrapper { display: flex; align-items: center; gap: 0.5rem; background: var(--card); padding: 0.2rem 0.4rem; border-radius: 5px; border: 1px solid var(--border); }
        .addon-select-wrapper select { flex: 1; background: var(--card); border: none; color: var(--text); font-family: inherit; font-size: 0.8rem; cursor: pointer; outline: none; -webkit-appearance: none; padding: 0.2rem; }
        .addon-select-wrapper select option { background: var(--card); color: var(--text); }
        .btn-icon { background: transparent; border: none; cursor: pointer; font-size: 0.8rem; padding: 0.2rem; border-radius: 4px; color: var(--text-dim); }
        .btn-icon:hover { background: var(--bg-tertiary); color: var(--primary); }
        .addon-status { font-size: 0.65rem; margin-top: 0.25rem; color: var(--success); max-width: 170px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: help; direction: rtl; text-align: left; }
        .addon-status::before { content: ''; unicode-bidi: bidi-override; direction: ltr; }

        /* Get Started Overlay */
        .get-started-overlay { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(10, 15, 26, 0.95); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 100; text-align: center; padding: 2rem;
        }
        .get-started-overlay.hidden { display: none; }
        .get-started-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.8; }
        .get-started-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text); }
        .get-started-text { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1.5rem; max-width: 400px; line-height: 1.6; }
        .get-started-btn { background: var(--primary); color: var(--bg); padding: 0.75rem 1.5rem; border-radius: 8px; border: none; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
        .get-started-btn:hover { background: #7dd3fc; }

        /* Sidebar Sections */
        .sidebar-section { padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); }
        .sidebar-title { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-dim); margin-bottom: 0.375rem; }
        .cmd-btn { 
            width: 100%; padding: 0.375rem 0.5rem; margin-bottom: 0.125rem;
            background: transparent; border: 1px solid transparent; border-radius: 4px;
            color: var(--text-muted); font-size: 0.7rem; text-align: left;
            cursor: pointer; transition: all 0.1s; display: flex; align-items: center; gap: 0.375rem;
        }
        .cmd-btn:hover { background: var(--card); color: var(--text); border-color: var(--border); }
        .cmd-btn.active { background: var(--primary-glow); color: var(--primary); border-color: var(--primary); }
        .cmd-icon { font-size: 0.75rem; width: 1rem; text-align: center; }

        /* Main Content Views */
        .view { display: none; flex: 1 1 0; min-height: 0; overflow-y: auto; }
        .view.active { display: block; }
        #view-sandbox { flex-direction: column; }
        #view-sandbox.active { display: flex; overflow: hidden; }
        #view-sandbox .output-header,
        #view-sandbox .output-stats { flex-shrink: 0; }
        #view-sandbox .output-section.sandbox-stubs { flex-shrink: 0; }
        #view-sandbox .output-section.sandbox-results {
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
            margin-bottom: 0;
        }
        #view-sandbox .output-section.sandbox-results .output-section-header { flex-shrink: 0; }
        #view-sandbox .output-section.sandbox-results .output-section-body {
            flex: 1 1 0;
            overflow-y: auto;
            min-height: 0;
            max-height: none;
        }

        /* Command View Header */
        .command-header { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1rem; background: var(--card); border-radius: 8px; margin-bottom: 1rem;
        }
        .command-info { flex: 1; }
        .command-name { font-family: var(--mono); font-size: 1rem; color: var(--primary); margin-bottom: 0.25rem; }
        .command-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .command-meta { font-size: 0.7rem; color: var(--text-dim); display: flex; align-items: center; gap: 1rem; }
        .command-actions { display: flex; align-items: center; gap: 0.75rem; }
        .history-nav { display: flex; align-items: center; gap: 0.5rem; }
        .history-info { font-size: 0.65rem; color: var(--text-dim); }

        /* Command Result */
        .result-section { margin-bottom: 1rem; }
        .result-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim); margin-bottom: 0.375rem; display: flex; align-items: center; gap: 0.375rem; }
        .result-value { font-size: 0.8rem; color: var(--text); }
        .result-status { display: inline-block; font-size: 0.65rem; padding: 0.125rem 0.375rem; border-radius: 4px; }
        .result-status.success { background: var(--success-glow); color: var(--success); }
        .result-status.error { background: var(--error-glow); color: var(--error); }
        .result-data { background: var(--bg-tertiary); border-radius: 6px; padding: 0.75rem; font-family: var(--mono); font-size: 0.75rem; color: var(--text-muted); max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
        .confidence-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; margin-top: 0.25rem; }
        .confidence-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); transition: width 0.3s; }
        .source-list { list-style: none; }
        .source-item { font-size: 0.75rem; color: var(--text-muted); padding: 0.2rem 0; display: flex; align-items: center; gap: 0.375rem; }

        /* Mechanic Output View */
        .mechanic-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .mechanic-card { background: var(--card); border-radius: 8px; padding: 1rem; border: 1px solid var(--border); }
        .mechanic-card-title { font-size: 0.7rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.75rem; }
        .health-row { display: flex; justify-content: space-between; padding: 0.375rem 0; font-size: 0.8rem; color: var(--text-muted); border-bottom: 1px solid var(--border); }
        .health-row:last-child { border-bottom: none; }
        .health-row .value { color: var(--text); font-weight: 500; }
        .health-row .value.success { color: var(--success); }
        .health-row .value.warning { color: var(--warning); }
        .test-hero { text-align: center; padding: 1.5rem; background: var(--success-glow); border-radius: 8px; border: 1px solid rgba(74, 222, 128, 0.3); }
        .test-hero.failing { background: var(--error-glow); border-color: rgba(248, 113, 113, 0.3); }
        .test-hero-status { font-size: 2.5rem; margin-bottom: 0.25rem; }
        .test-hero-count { font-size: 1rem; color: var(--text-muted); }
        .test-list { list-style: none; margin-top: 1rem; }
        .test-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.8rem; }

        /* Console */
        .console-header { padding: 0.375rem 0.75rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: var(--text-muted); }
        .console-body { flex: 1; display: flex; flex-direction: column; padding: 0.5rem 0.75rem; }
        .console-input-row { display: flex; gap: 0.375rem; margin-bottom: 0.375rem; }
        .console-input { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 0.375rem 0.5rem; color: var(--text); font-family: var(--mono); font-size: 0.75rem; }
        .console-input:focus { outline: none; border-color: var(--primary); }
        .console-input.cmd { width: 140px; flex: none; }
        .console-output { flex: 1; background: var(--bg); border-radius: 4px; padding: 0.375rem 0.5rem; font-family: var(--mono); font-size: 0.65rem; color: var(--text-dim); overflow-y: auto; white-space: pre-wrap; }

        /* Toast Notifications */
        .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { 
            background: var(--card); border: 1px solid var(--border); border-radius: 8px; 
            padding: 0.75rem 1rem; min-width: 280px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
        }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast-title { font-size: 0.75rem; font-weight: 600; color: var(--text); margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.375rem; }
        .toast-message { font-size: 0.7rem; color: var(--text-muted); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* Tool Banner */
        .tool-banner { background: var(--error-glow); border-bottom: 1px solid var(--error); padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--error); }
        .tool-banner code { background: var(--card); padding: 0.125rem 0.375rem; border-radius: 4px; font-family: var(--mono); color: var(--text); }
        .tool-banner-hint { color: var(--text-muted); }

        /* Status Bar */
        .status-bar { padding: 0.375rem 1rem; background: var(--bg-tertiary); border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 0.65rem; color: var(--text-dim); }
        .status-left { display: flex; align-items: center; gap: 1rem; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 0.375rem; display: inline-block; }
        .status-dot.connected { background: var(--success); box-shadow: 0 0 6px var(--success); }
        .status-dot.disconnected { background: var(--error); }
        .shortcuts { display: flex; gap: 1rem; }
        .shortcut { display: flex; align-items: center; gap: 0.25rem; }

        /* No result state */
        .no-result { text-align: center; padding: 3rem; color: var(--text-dim); }
        .no-result-icon { font-size: 3rem; margin-bottom: 0.5rem; opacity: 0.5; }
        .no-result-text { font-size: 0.9rem; }

        /* Library Manager View */
        .lib-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .lib-header-title { font-size: 1.1rem; font-weight: 600; }
        .lib-header-actions { display: flex; gap: 0.5rem; }
        .lib-stats { display: flex; gap: 1.5rem; margin-bottom: 1rem; }
        .lib-stat { background: var(--card); padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--border); text-align: center; min-width: 100px; }
        .lib-stat-value { font-size: 1.5rem; font-weight: 700; }
        .lib-stat-value.ok { color: var(--success); }
        .lib-stat-value.missing { color: var(--error); }
        .lib-stat-value.extra { color: var(--warning); }
        .lib-stat-label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; }
        
        .lib-table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 8px; overflow: hidden; }
        .lib-table th { text-align: left; padding: 0.75rem 1rem; background: var(--bg-tertiary); font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); border-bottom: 1px solid var(--border); }
        .lib-table td { padding: 0.625rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
        .lib-table tr:last-child td { border-bottom: none; }
        .lib-table tr:hover { background: var(--bg-tertiary); }
        .lib-name { font-family: var(--mono); color: var(--text); }
        .lib-version { color: var(--text-muted); font-family: var(--mono); font-size: 0.75rem; }
        .lib-badge { display: inline-block; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; }
        .lib-badge.ok { background: var(--success-glow); color: var(--success); }
        .lib-badge.missing { background: var(--error-glow); color: var(--error); }
        .lib-badge.extra { background: rgba(251, 191, 36, 0.15); color: var(--warning); }
        .lib-badge.local { background: var(--primary-glow); color: var(--primary); }
        .lib-config-status { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 1rem; font-size: 0.8rem; }
        .lib-config-status.found { border-left: 3px solid var(--success); }
        .lib-config-status.missing { border-left: 3px solid var(--warning); }

        /* Settings View */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        .settings-card { background: var(--card); border-radius: 8px; padding: 1rem; border: 1px solid var(--border); }
        .settings-card-title { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
        .settings-row:last-child { border-bottom: none; }
        .settings-row .label { color: var(--text-muted); }
        .settings-row .value { color: var(--text); font-family: var(--mono); font-size: 0.75rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .settings-row .value.success { color: var(--success); }
        .settings-row .value.error { color: var(--error); }
        .flavor-list { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .flavor-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; background: var(--bg-tertiary); border: 1px solid var(--border); }
        .flavor-badge.active { background: var(--success-glow); border-color: var(--success); color: var(--success); }
        .flavor-badge.inactive { color: var(--text-dim); }
        .path-display { font-family: var(--mono); font-size: 0.7rem; color: var(--text-muted); padding: 0.5rem; background: var(--bg); border-radius: 4px; margin-top: 0.5rem; word-break: break-all; }

        /* Addon Management in Settings */
        .settings-card-full { grid-column: 1 / -1; }
        .addon-list { max-height: 200px; overflow-y: auto; margin-bottom: 0.75rem; }
        .addon-list-empty { color: var(--text-dim); font-size: 0.8rem; padding: 1rem; text-align: center; }
        .addon-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
        .addon-list-item:last-child { border-bottom: none; }
        .addon-list-item:hover { background: var(--bg-tertiary); }
        .addon-list-item .addon-name { font-weight: 600; color: var(--text); }
        .addon-list-item .addon-path { font-family: var(--mono); font-size: 0.65rem; color: var(--text-dim); margin-top: 0.125rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 400px; }
        .addon-list-item .btn-remove { background: transparent; border: none; color: var(--text-dim); cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; }
        .addon-list-item .btn-remove:hover { background: var(--error-glow); color: var(--error); }
        .addon-list-actions { display: flex; gap: 0.5rem; }

        /* Addon Output Pane */
        .output-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }
        .output-header-title { font-size: 0.9rem; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 0.5rem; }
        .output-header-meta { font-size: 0.7rem; color: var(--text-dim); display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; }
        
        .output-stats { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
        .output-stat { flex: 1; background: var(--card); border-radius: 6px; padding: 0.625rem 0.75rem; border: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem; }
        .output-stat-icon { font-size: 1.25rem; }
        .output-stat-info { flex: 1; }
        .output-stat-value { font-size: 1.25rem; font-weight: 700; line-height: 1; }
        .output-stat-value.error { color: var(--error); }
        .output-stat-value.success { color: var(--success); }
        .output-stat-value.info { color: var(--primary); }
        .output-stat-label { font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; }
        .output-stat-action { padding: 0.375rem 0.625rem; font-size: 0.65rem; }
        
        .output-section { background: var(--card); border-radius: 8px; border: 1px solid var(--border); margin-bottom: 0.75rem; overflow: hidden; }
        .output-section-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border); cursor: pointer; }
        .output-section-header:hover { background: var(--bg-secondary); }
        .output-section-title { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: var(--text-muted); display: flex; align-items: center; gap: 0.5rem; }
        .output-section-meta { font-size: 0.65rem; color: var(--text-dim); }
        .output-section-body { max-height: 250px; overflow-y: auto; }
        .output-section-body.collapsed { display: none; }
        
        .error-tree { padding: 0.5rem 0; }
        .error-addon { border-bottom: 1px solid var(--border); }
        .error-addon:last-child { border-bottom: none; }
        .error-addon-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.75rem; }
        .error-addon-header:hover { background: var(--bg-tertiary); }
        .error-addon-name { font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 0.375rem; }
        .error-addon-name .chevron { color: var(--text-dim); transition: transform 0.15s; }
        .error-addon-name.expanded .chevron { transform: rotate(90deg); }
        .error-addon-count { font-size: 0.65rem; color: var(--error); background: var(--error-glow); padding: 0.125rem 0.375rem; border-radius: 4px; }
        .error-addon-items { display: none; padding-left: 1.25rem; }
        .error-addon-items.expanded { display: block; }
        .error-item { display: flex; gap: 0.5rem; padding: 0.375rem 0.75rem; font-size: 0.7rem; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .error-item:hover { background: var(--bg-tertiary); }
        .error-item:last-child { border-bottom: none; }
        .error-location { font-family: var(--mono); color: var(--primary); white-space: nowrap; }
        .error-count { font-size: 0.6rem; color: var(--warning); margin-left: 0.25rem; }
        .error-message { color: var(--text-muted); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .error-detail { display: none; background: var(--bg); padding: 0.5rem 0.75rem; margin: 0.25rem 0.75rem; border-radius: 4px; font-family: var(--mono); font-size: 0.65rem; color: var(--text-dim); white-space: pre-wrap; }
        .error-detail.expanded { display: block; }
        
        /* Test Results Tree */
        .test-tree { padding: 0.5rem 0; }
        .test-addon { border-bottom: 1px solid var(--border); }
        .test-addon:last-child { border-bottom: none; }
        .test-addon-header { 
            padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.02);
            font-size: 0.75rem; font-weight: 700; color: var(--text);
            display: flex; align-items: center; gap: 0.5rem;
        }
        .test-category { padding-left: 0.75rem; margin-bottom: 0.5rem; }
        .test-category-header { 
            padding: 0.375rem 0.75rem; font-size: 0.65rem; font-weight: 600; 
            text-transform: uppercase; color: var(--text-dim); letter-spacing: 0.05em;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .test-category-header::before { content: ''; width: 4px; height: 1px; background: var(--border-light); }
        
        .test-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0.375rem 0.75rem 0.375rem 2rem; font-size: 0.75rem; 
            cursor: pointer; transition: background 0.1s;
        }
        .test-row:hover { background: var(--bg-tertiary); }
        .test-row.no-click { cursor: default; }
        .test-row.no-click:hover { background: transparent; }
        .test-info { display: flex; align-items: center; gap: 0.625rem; flex: 1; }
        .test-status-bullet { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .test-status-bullet.pass { background: var(--success); box-shadow: 0 0 6px var(--success-glow); }
        .test-status-bullet.fail { background: var(--error); box-shadow: 0 0 6px var(--error-glow); }
        .test-name { color: var(--text); font-weight: 500; }
        .test-meta { color: var(--text-dim); font-size: 0.65rem; font-family: var(--mono); }
        .test-chevron { font-size: 0.6rem; color: var(--text-dim); margin-left: 0.5rem; transition: transform 0.15s; }
        .test-row.expanded .test-chevron { transform: rotate(90deg); }

        .test-details-pane-perf { 
            display: none; background: rgba(56, 189, 248, 0.03); margin: 0.25rem 0.75rem 0.75rem 0.75rem; 
            border-radius: 6px; border: 1px solid var(--border-light); padding: 0.75rem;
            font-size: 0.7rem;
        }
        .test-details-pane-perf.expanded { display: block; }
        .test-addon-perf-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.5rem 0.75rem; margin: 0.25rem 0.75rem;
            background: rgba(56, 189, 248, 0.05); border-radius: 6px;
            cursor: pointer; font-size: 0.7rem; color: var(--text); border: 1px solid transparent;
            transition: all 0.1s;
        }
        .test-addon-perf-row:hover { border-color: var(--primary); background: rgba(56, 189, 248, 0.08); }
        .test-chevron-perf { font-size: 0.6rem; color: var(--primary); transition: transform 0.15s; }

        .test-details-pane { 
            display: none; background: var(--bg); margin: 0 0.75rem 0.5rem 2.5rem; 
            border-radius: 6px; border: 1px solid var(--border); padding: 0.75rem;
            font-size: 0.7rem;
        }
        .test-details-pane.expanded { display: block; }
        .test-msg { color: var(--warning); margin-bottom: 0.5rem; font-family: var(--mono); }
        .test-detail-item { color: var(--text-muted); padding: 0.125rem 0; display: flex; gap: 0.5rem; }
        .test-detail-item span { color: var(--primary); font-family: var(--mono); }
        .test-captured-logs { 
            margin-top: 0.75rem; background: var(--bg-secondary); border-radius: 4px; 
            padding: 0.5rem; font-family: var(--mono); font-size: 0.65rem; color: var(--text-dim);
            max-height: 150px; overflow-y: auto; border-left: 2px solid var(--border-light);
        }
        .test-label-small { font-size: 0.6rem; text-transform: uppercase; color: var(--text-dim); margin-bottom: 0.25rem; display: block; }
        
        .console-log { font-family: var(--mono); font-size: 0.65rem; }
        .console-filters { display: flex; gap: 0.375rem; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); }
        .console-filter { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.6rem; background: var(--bg); border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; }
        .console-filter:hover { border-color: var(--border-light); }
        .console-filter.active { background: var(--primary-glow); border-color: var(--primary); color: var(--primary); }
        .console-entries { padding: 0.5rem 0; }
        .console-entry { padding: 0.25rem 0.75rem; display: flex; gap: 0.5rem; }
        .console-entry:hover { background: var(--bg-tertiary); }
        .console-source { color: var(--primary); white-space: nowrap; }
        .console-category { color: var(--warning); white-space: nowrap; }
        .console-message { color: var(--text-muted); }
        .lib-badge-small {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.15rem 0.45rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-family: var(--mono);
            background: var(--bg-tertiary);
            color: var(--text-muted);
            border: 1px solid var(--border);
            transition: all 0.1s;
        }
        .lib-badge-small:hover {
            border-color: var(--border-light);
            color: var(--text);
        }
        .lib-badge-small.highlight {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-glow);
        }
        .lib-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-bottom: 1rem;
            padding: 0 0.25rem;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">MECHANIC <span>v0.3.0</span></div>
            <button id="mechanic-tab" class="btn btn-ghost addon-output-btn" title="View addon sync status">
                <span>üìä</span> Addon Output
            </button>
        </div>
        <div class="header-actions">
            <button id="btn-create-nav" class="btn btn-ghost">‚ûï Create</button>
            <button id="btn-reload" class="btn btn-primary">‚ö° Reload <span class="kbd">R</span></button>
            <div class="header-spacer"></div>
            <button id="btn-settings" class="btn btn-ghost btn-icon-only" title="Settings">‚öôÔ∏è</button>
            <button id="btn-stop" class="btn btn-ghost btn-icon-only btn-stop" title="Stop Server">‚èª</button>
        </div>
    </header>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Addon Selector -->
            <div class="addon-context">
                <div class="addon-context-label">üéØ Target Addon</div>
                <div class="addon-select-wrapper">
                    <select id="addon-select">
                        <option value="">Select an addon...</option>
                    </select>
                    <button id="btn-add-addon" class="btn-icon" title="Add Addon from .toc">‚ûï</button>
                </div>
                <div id="addon-status" class="addon-status">Add an addon to get started</div>
            </div>

            <!-- Sandbox -->
            <div class="sidebar-section">
                <div class="sidebar-title">Sandbox</div>
                <button id="sandbox-tab" class="cmd-btn" title="Test Core/ layer offline without WoW">
                    <span class="cmd-icon">üß™</span> Sandbox Tests
                </button>
            </div>

            <!-- Development -->
            <div class="sidebar-section">
                <div class="sidebar-title">Development</div>
                <button class="cmd-btn" data-cmd="addon.validate"><span class="cmd-icon">‚úì</span> Validate</button>
                <button class="cmd-btn" data-cmd="addon.lint"><span class="cmd-icon">üîç</span> Lint</button>
                <button class="cmd-btn" data-cmd="addon.format"><span class="cmd-icon">‚ú®</span> Format</button>
                <button class="cmd-btn" data-cmd="addon.test"><span class="cmd-icon">üß™</span> Test</button>
                <button class="cmd-btn" data-cmd="addon.deprecations"><span class="cmd-icon">‚ö†Ô∏è</span> Deprecations</button>
            </div>

            <!-- Release -->
            <div class="sidebar-section">
                <div class="sidebar-title">Release</div>
                <button class="cmd-btn" data-cmd="release.all"><span class="cmd-icon">üöÄ</span> Release All</button>
                <button class="cmd-btn" data-cmd="version.bump"><span class="cmd-icon">üè∑Ô∏è</span> Bump Version</button>
                <button class="cmd-btn" data-cmd="changelog.add"><span class="cmd-icon">üìù</span> Changelog</button>
                <button class="cmd-btn" data-cmd="git.commit"><span class="cmd-icon">üíæ</span> Commit</button>
                <button class="cmd-btn" data-cmd="git.tag"><span class="cmd-icon">üîñ</span> Tag</button>
            </div>

            <!-- Quality -->
            <div class="sidebar-section">
                <div class="sidebar-title">Quality</div>
                <button class="cmd-btn" data-cmd="locale.validate"><span class="cmd-icon">üó£Ô∏è</span> Validate Locale</button>
                <button class="cmd-btn" data-cmd="locale.extract"><span class="cmd-icon">üì§</span> Extract Locals</button>
                <button class="cmd-btn" data-cmd="atlas.search"><span class="cmd-icon">üé®</span> Atlas</button>
            </div>

            <!-- Libraries -->
            <div class="sidebar-section">
                <div class="sidebar-title">Libraries</div>
                <button class="cmd-btn" data-view="libraries"><span class="cmd-icon">üìä</span> Library Manager</button>
                <button class="cmd-btn" data-cmd="libs.check"><span class="cmd-icon">‚úì</span> Check Status</button>
                <button class="cmd-btn" data-cmd="libs.sync"><span class="cmd-icon">üîÑ</span> Sync Libraries</button>
                <button class="cmd-btn" data-cmd="libs.init"><span class="cmd-icon">üìù</span> Init Config</button>
            </div>

            <!-- Environment -->
            <div class="sidebar-section">
                <div class="sidebar-title">Sync</div>
                <button class="cmd-btn" data-cmd="addon.sync"><span class="cmd-icon">üìÇ</span> Sync to Client</button>
            </div>

            <!-- Project -->
            <!-- Moved to Header -->
        </aside>

        <!-- Main Area -->
        <main class="main-area" style="position: relative;">
            <!-- Get Started Overlay -->
            <div id="get-started-overlay" class="get-started-overlay">
                <div class="get-started-icon">üîß</div>
                <div class="get-started-title">Welcome to Mechanic</div>
                <div class="get-started-text">
                    Select an addon to get started. You can add addons by clicking the ‚ûï button in the sidebar, or create a new one.
                </div>
                <button id="btn-get-started" class="get-started-btn">
                    <span>‚ûï</span> Add Your First Addon
                </button>
            </div>

            <!-- Tool Setup Banner -->
            <div id="tool-banner" class="tool-banner" style="display: none;">
                <span>‚ö†Ô∏è Development tools missing (Luacheck, StyLua)</span>
                <span class="tool-banner-hint">Run: <code>mechanic setup</code></span>
            </div>
            
            <div class="content-area">
                <!-- Addon Output View -->
                <div id="view-mechanic" class="view active">
                    <!-- Header -->
                    <div class="output-header">
                        <div class="output-header-title">üìä Addon Output</div>
                        <div class="output-header-meta">
                            Last reload: <span id="output-reload-time">‚Äî</span>
                            <button id="btn-copy-output" class="btn btn-ghost output-stat-action" style="padding: 0.125rem 0.5rem; height: auto;" title="Copy all output as markdown for AI">
                                üìã Copy All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stats Bar -->
                    <div class="output-stats">
                        <div class="output-stat">
                            <div class="output-stat-icon">‚ùå</div>
                            <div class="output-stat-info">
                                <div id="output-error-count" class="output-stat-value error">0</div>
                                <div class="output-stat-label">Errors</div>
                            </div>
                        </div>
                        <div class="output-stat">
                            <div class="output-stat-icon">‚úÖ</div>
                            <div class="output-stat-info">
                                <div id="output-test-count" class="output-stat-value success">0/0</div>
                                <div class="output-stat-label">Tests</div>
                            </div>
                        </div>
                        <div class="output-stat">
                            <div class="output-stat-icon">üìù</div>
                            <div class="output-stat-info">
                                <div id="output-console-count" class="output-stat-value info">0</div>
                                <div class="output-stat-label">Console</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Libraries Row -->
                    <div id="output-libraries-row" class="lib-row" style="display: none;">
                    </div>
                    
                    <!-- Errors Section -->
                    <div class="output-section">
                        <div class="output-section-header" onclick="toggleSection('errors')">
                            <div class="output-section-title">‚ùå Errors <span id="output-error-summary" style="font-weight: normal; color: var(--text-dim);">(grouped by addon)</span></div>
                            <div class="output-section-meta">‚ñº</div>
                        </div>
                        <div id="output-errors-body" class="output-section-body">
                            <div id="output-error-tree" class="error-tree">
                                <div style="padding: 1rem; color: var(--text-dim); text-align: center;">No errors. Do /reload in-game to capture data.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Addon Tests Container (dynamic sections per addon) -->
                    <div id="output-addon-tests-container"></div>
                    
                    <!-- Console Section -->
                    <div class="output-section">
                        <div class="output-section-header" onclick="toggleSection('console')">
                            <div class="output-section-title">üìù Console</div>
                            <div class="output-section-meta">‚ñº</div>
                        </div>
                        <div id="output-console-body" class="output-section-body console-log">
                            <div class="console-filters">
                                <button class="console-filter active" data-filter="all">All</button>
                                <button class="console-filter" data-filter="System">System</button>
                                <button class="console-filter" data-filter="Debug">Debug</button>
                                <button class="console-filter" data-filter="Error">Error</button>
                            </div>
                            <div id="output-console-entries" class="console-entries">
                                <div style="padding: 0.5rem 0.75rem; color: var(--text-dim);">No console entries. Do /reload in-game to capture logs.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Command View (dynamic for each command) -->
                <div id="view-command" class="view">
                    <div class="command-header">
                        <div class="command-info">
                            <div id="cmd-name" class="command-name">addon.validate</div>
                            <div id="cmd-desc" class="command-desc">Description</div>
                            <div class="command-meta">
                                <span id="cmd-status" class="result-status success">‚Äî</span>
                                <span id="cmd-time">‚Äî</span>
                            </div>
                        </div>
                        <div class="command-actions">
                            <div class="history-nav">
                                <button id="btn-prev" class="btn btn-nav" disabled>‚óÄ</button>
                                <span id="history-info" class="history-info">‚Äî</span>
                                <button id="btn-next" class="btn btn-nav" disabled>‚ñ∂</button>
                            </div>
                            <button id="btn-clear-history" class="btn btn-ghost" title="Clear history for this command">üóëÔ∏è</button>
                            <button id="btn-run-cmd" class="btn btn-run">‚ñ∂ Run</button>
                        </div>
                    </div>
                    
                    <div id="cmd-no-result" class="no-result">
                        <div class="no-result-icon">üìã</div>
                        <div class="no-result-text">No runs yet. Click "Run" to execute this command.</div>
                    </div>
                    
                    <div id="cmd-result" style="display: none;">
                        <div class="result-section">
                            <div class="result-label">üí° Reasoning</div>
                            <div id="result-reasoning" class="result-value">‚Äî</div>
                        </div>
                        <div class="result-section">
                            <div class="result-label">üìä Confidence</div>
                            <div class="confidence-bar"><div id="confidence-fill" class="confidence-fill" style="width: 0%;"></div></div>
                            <div id="confidence-text" style="font-size: 0.65rem; color: var(--text-dim); margin-top: 0.25rem;">‚Äî</div>
                        </div>
                        <div class="result-section">
                            <div class="result-label">üìã Sources</div>
                            <ul id="source-list" class="source-list"></ul>
                        </div>
                        <div class="result-section">
                            <div class="result-label">üì¶ Data</div>
                            <div id="result-data" class="result-data">// Output</div>
                        </div>
                    </div>
                </div>

                <!-- Library Manager View -->
                <div id="view-libraries" class="view">
                    <div class="lib-header">
                        <div class="lib-header-title">üìö Library Manager</div>
                        <div class="lib-header-actions">
                            <button id="btn-lib-refresh" class="btn btn-ghost">üîÑ Refresh</button>
                            <button id="btn-lib-sync" class="btn btn-ghost">‚¨áÔ∏è Sync Missing</button>
                            <button id="btn-lib-force-sync" class="btn btn-primary">‚¨ÜÔ∏è Force Update All</button>
                        </div>
                    </div>

                    <div id="lib-config-banner" class="lib-config-status missing">
                        <span>‚ö†Ô∏è</span>
                        <span>No <code>libs.json</code> found. <a href="#" id="btn-lib-init" style="color: var(--primary)">Initialize config</a> to manage libraries.</span>
                    </div>

                    <div class="lib-stats">
                        <div class="lib-stat">
                            <div id="lib-stat-ok" class="lib-stat-value ok">‚Äî</div>
                            <div class="lib-stat-label">Installed</div>
                        </div>
                        <div class="lib-stat">
                            <div id="lib-stat-missing" class="lib-stat-value missing">‚Äî</div>
                            <div class="lib-stat-label">Missing</div>
                        </div>
                        <div class="lib-stat">
                            <div id="lib-stat-extra" class="lib-stat-value extra">‚Äî</div>
                            <div class="lib-stat-label">Extra</div>
                        </div>
                    </div>

                    <table class="lib-table">
                        <thead>
                            <tr>
                                <th>Library</th>
                                <th>Configured</th>
                                <th>Installed</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="lib-table-body">
                            <tr><td colspan="4" style="text-align: center; color: var(--text-dim); padding: 2rem;">Select an addon and click Refresh to check libraries</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Settings View -->
                <div id="view-settings" class="view">
                    <div class="lib-header">
                        <div class="lib-header-title">‚öôÔ∏è Environment Settings</div>
                        <div class="lib-header-actions">
                            <button id="btn-settings-refresh" class="btn btn-ghost">üîÑ Refresh</button>
                        </div>
                    </div>

                    <div class="settings-grid">
                        <div class="settings-card">
                            <div class="settings-card-title">üéÆ WoW Installation</div>
                            <div class="settings-row">
                                <span class="label">Root Path</span>
                                <span id="settings-wow-root" class="value">‚Äî</span>
                            </div>
                            <div class="settings-row">
                                <span class="label">Dev Path</span>
                                <span id="settings-dev-path" class="value">‚Äî</span>
                            </div>
                            <div id="settings-wow-path-full" class="path-display">‚Äî</div>
                        </div>

                        <div class="settings-card">
                            <div class="settings-card-title">üìÇ Game Clients</div>
                            <div id="settings-flavors" class="flavor-list">
                                <span class="flavor-badge">Loading...</span>
                            </div>
                        </div>

                        <div class="settings-card">
                            <div class="settings-card-title">üîß Development Tools</div>
                            <div class="settings-row">
                                <span class="label">Luacheck</span>
                                <span id="settings-luacheck" class="value">‚Äî</span>
                            </div>
                            <div class="settings-row">
                                <span class="label">StyLua</span>
                                <span id="settings-stylua" class="value">‚Äî</span>
                            </div>
                            <div class="settings-row">
                                <span class="label">Lua</span>
                                <span id="settings-lua" class="value">‚Äî</span>
                            </div>
                            <div class="settings-row">
                                <span class="label">Busted</span>
                                <span id="settings-busted" class="value">‚Äî</span>
                            </div>
                        </div>

                        <div class="settings-card">
                            <div class="settings-card-title">üåê Server</div>
                            <div class="settings-row">
                                <span class="label">Port</span>
                                <span class="value">3100</span>
                            </div>
                            <div class="settings-row">
                                <span class="label">Status</span>
                                <span id="settings-server-status" class="value success">Running</span>
                            </div>
                            <div class="settings-row">
                                <span class="label">Data Directory</span>
                                <span id="settings-data-dir" class="value">‚Äî</span>
                            </div>
                        </div>

                        <div class="settings-card settings-card-full">
                            <div class="settings-card-title">üì¶ Registered Addons</div>
                            <div id="settings-addon-list" class="addon-list">
                                <div class="addon-list-empty">No addons registered. Click + in the sidebar to add one.</div>
                            </div>
                            <div class="addon-list-actions">
                                <button id="btn-settings-add-addon" class="btn btn-ghost">‚ûï Add Addon</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sandbox View -->
                <div id="view-sandbox" class="view">
                    <div class="output-header">
                        <div class="output-header-title">üß™ Sandbox Testing</div>
                        <div class="output-header-meta">
                            Test addon Core logic outside WoW
                            <button id="btn-sandbox-run" class="btn btn-run" style="margin-left: 0.5rem;">‚ñ∂ Run Tests</button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="output-stats">
                        <div class="output-stat">
                            <div class="output-stat-icon">‚úÖ</div>
                            <div class="output-stat-info">
                                <div id="sandbox-passed" class="output-stat-value success">0</div>
                                <div class="output-stat-label">Passed</div>
                            </div>
                        </div>
                        <div class="output-stat">
                            <div class="output-stat-icon">‚ùå</div>
                            <div class="output-stat-info">
                                <div id="sandbox-failed" class="output-stat-value error">0</div>
                                <div class="output-stat-label">Failed</div>
                            </div>
                        </div>
                        <div class="output-stat">
                            <div class="output-stat-icon">üìÅ</div>
                            <div class="output-stat-info">
                                <div id="sandbox-addon" class="output-stat-value info">‚Äî</div>
                                <div class="output-stat-label">Addon</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- API Stubs (compact, always visible) -->
                    <div class="output-section sandbox-stubs">
                        <div class="output-section-header">
                            <div class="output-section-title">üì¶ API Stubs</div>
                            <button id="btn-sandbox-generate" class="btn btn-ghost" style="padding: 0.125rem 0.5rem; height: auto;">üîÑ Regenerate</button>
                        </div>
                        <div class="output-section-body" style="padding: 0.5rem 0.75rem;">
                            <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
                                <div class="health-row" style="margin: 0;"><span>Status</span><span id="sandbox-stubs-status" class="value success">‚Äî</span></div>
                                <div class="health-row" style="margin: 0;"><span>Total</span><span id="sandbox-stubs-total" class="value">‚Äî</span></div>
                                <div class="health-row" style="margin: 0;"><span>Protected</span><span id="sandbox-stubs-protected" class="value">‚Äî</span></div>
                                <div class="health-row" style="margin: 0;"><span>Normal</span><span id="sandbox-stubs-normal" class="value">‚Äî</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Results (takes remaining space) -->
                    <div class="output-section sandbox-results">
                        <div class="output-section-header">
                            <div class="output-section-title">üß™ Test Results</div>
                            <div id="sandbox-summary" class="output-section-meta">No tests run yet</div>
                        </div>
                        <div id="sandbox-results-body" class="output-section-body">
                            <div id="sandbox-results" class="test-tree">
                                <div style="padding: 1rem; color: var(--text-dim); text-align: center;">
                                    Select an addon and click "Run Tests" to execute sandbox tests.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Console -->
            <div class="console-area">
                <div class="console-header">
                    <span>üñ•Ô∏è Console</span>
                </div>
                <div class="console-body">
                    <div class="console-input-row">
                        <input id="console-cmd" class="console-input cmd" placeholder="Command">
                        <input id="console-input" class="console-input" placeholder='{"addon": "Weekly"}'>
                        <button id="btn-execute" class="btn btn-ghost">‚ñ∂</button>
                    </div>
                    <div id="console-output" class="console-output">// Ready</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-left">
            <span><span id="status-dot" class="status-dot disconnected"></span><span id="status-text">Connecting...</span></span>
            <span>Port 3100</span>
            <span id="uptime">0s</span>
            <span id="accounts-info">Accounts: Loading...</span>
        </div>
        <div class="shortcuts">
            <span class="shortcut"><span class="kbd">R</span> Reload</span>
            <span class="shortcut"><span class="kbd">V</span> Validate</span>
            <span class="shortcut"><span class="kbd">:</span> Console</span>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let selectedAddon = localStorage.getItem('mechanic.selectedAddon') || '';
        let currentCommand = null;
        let startTime = Date.now();
        
        // Command history: { "addon.validate": [result1, result2, ...], ... }
        const commandHistory = {};
        // Current index per command: { "addon.validate": 0, ... }
        const historyIndex = {};
        
        // Addons are discovered dynamically - no hardcoded list
        const mechanicAddons = [];
        
        // Default parameters for commands
        const commandDefaults = {
            'release.all': { version: '1.2.3', message: 'Release features', category: 'Changed' },
            'version.bump': { version: '1.2.3' },
            'changelog.add': { version: '1.2.3', message: 'Added new feature' },
            'git.commit': { message: 'chore: update' },
            'git.tag': { version: '1.2.3' },
            'addon.create': { name: 'MyAddon', title: 'My Addon', author: 'Name', addon: null },
            'addon.sync': { flavors: null }, // Uses selected addon
            'atlas.search': { query: 'inv_sword' }
        };

        // { "MyAddon": "C:/Path/To/MyAddon" }
        let knownAddons = JSON.parse(localStorage.getItem('mechanic.addons') || '{}');

        // Update addon dropdown from known addons (discovered + user-added)
        function updateAddonList() {
            const allAddons = Object.keys(knownAddons).sort();
            const overlay = document.getElementById('get-started-overlay');
            
            if (allAddons.length === 0) {
                addonSelect.innerHTML = '<option value="">Add an addon...</option>';
                addonStatus.textContent = 'Click + to add an addon';
                addonStatus.title = '';
                selectedAddon = '';
                overlay.classList.remove('hidden');
                return;
            }
            
            overlay.classList.add('hidden');
            addonSelect.innerHTML = allAddons.map(a => `<option value="${a}">${a}</option>`).join('');
            
            if (selectedAddon && allAddons.includes(selectedAddon)) {
                addonSelect.value = selectedAddon;
            } else {
                selectedAddon = allAddons[0];
                addonSelect.value = selectedAddon;
            }
            updateAddonStatus();
        }

        function updateAddonStatus() {
            const overlay = document.getElementById('get-started-overlay');
            
            if (!selectedAddon) {
                addonStatus.textContent = 'Click + to add an addon';
                addonStatus.title = '';
                overlay.classList.remove('hidden');
                return;
            }
            
            overlay.classList.add('hidden');
            
            const addonPath = knownAddons[selectedAddon];
            if (addonPath) {
                // Show truncated path (start of path), full path on hover
                const shortPath = addonPath.length > 35 ? addonPath.slice(-35) + '‚Ä¶' : addonPath;
                addonStatus.textContent = shortPath;
                addonStatus.title = addonPath; // Full path on hover
            } else {
                addonStatus.textContent = '‚úì Registered';
                addonStatus.title = '';
            }
            
            // Update input with path if known
            const defaults = commandDefaults[currentCommand] || {};
            const payload = { addon: selectedAddon, ...defaults };
            if (addonPath) {
                payload.path = addonPath;
            }
            consoleInput.value = JSON.stringify(payload);
        }

        // Command descriptions
        const commandDescriptions = {
            'addon.validate': 'Checks for basic addon structure and critical files.',
            'addon.lint': 'Runs Luacheck to find syntax errors and global variable issues.',
            'addon.format': 'Runs StyLua to format code according to style guide.',
            'addon.test': 'Runs Busted unit tests.',
            'addon.deprecations': 'Scans for deprecated WoW API usage.',
            'version.bump': 'Updates the version number in the .toc file.',
            'changelog.add': 'Adds a new entry to CHANGELOG.md.',
            'git.commit': 'Stages all changes and creates a git commit.',
            'git.tag': 'Creates a git tag for the current version.',
            'release.all': 'Runs the full release flow: Bump -> Changelog -> Commit -> Tag.',
            'locale.validate': 'Checks if other locales match the enUS baseline keys.',
            'locale.extract': 'Scans Lua files for potential localizable strings.',
            'atlas.search': 'Searches the Blizzard Atlas for icons/textures.',
            'addon.create': 'Generates a new empty addon from a template.',
            'addon.sync': 'Syncs addon folder to game client directories.',
            'libs.check': 'Checks status of embedded libraries against libs.json config.',
            'libs.sync': 'Syncs libraries from source based on libs.json configuration.',
            'libs.init': 'Creates a libs.json config file from currently installed libraries.'
        };


        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ELEMENTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const addonSelect = document.getElementById('addon-select');
        const addonStatus = document.getElementById('addon-status');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const uptimeEl = document.getElementById('uptime');
        const consoleOutput = document.getElementById('console-output');
        const consoleCmd = document.getElementById('console-cmd');
        const consoleInput = document.getElementById('console-input');
        const accountsInfo = document.getElementById('accounts-info');
        const mechanicTab = document.getElementById('mechanic-tab');
        const sandboxTab = document.getElementById('sandbox-tab');
        const testHero = document.getElementById('test-hero');
        const testList = document.getElementById('test-list');

        // Command view elements
        const cmdName = document.getElementById('cmd-name');
        const cmdDesc = document.getElementById('cmd-desc');
        const cmdStatus = document.getElementById('cmd-status');
        const cmdTime = document.getElementById('cmd-time');
        const cmdNoResult = document.getElementById('cmd-no-result');
        const cmdResult = document.getElementById('cmd-result');
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        const historyInfo = document.getElementById('history-info');
        const btnRunCmd = document.getElementById('btn-run-cmd');

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TOAST NOTIFICATIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-title">${type === 'success' ? '‚úÖ' : '‚ùå'} ${title}</div>
                <div class="toast-message">${message}</div>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 10000);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // WEBSOCKET
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        ws.onopen = () => { statusDot.className = 'status-dot connected'; statusText.textContent = 'Connected'; };
        ws.onclose = () => { statusDot.className = 'status-dot disconnected'; statusText.textContent = 'Disconnected'; };
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.type === 'reload') updateTestResults(msg);
            if (msg.type === 'command_result') {
                // Command ran from external source (agent, CLI)
                addToHistory(msg.command, msg.result);
                showToast(msg.command, msg.result.reasoning || 'Completed', msg.result.success ? 'success' : 'error');
                // Update view if we're looking at this command
                if (currentCommand === msg.command) {
                    historyIndex[currentCommand] = commandHistory[currentCommand].length - 1;
                    displayCurrentResult();
                }
            }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VIEW SWITCHING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            mechanicTab.classList.toggle('active', viewName === 'mechanic');
            sandboxTab.classList.toggle('active', viewName === 'sandbox');
            document.querySelectorAll('.cmd-btn').forEach(b => b.classList.remove('active'));
            
            if (viewName === 'command' && currentCommand) {
                const btn = document.querySelector(`[data-cmd="${currentCommand}"]`);
                if (btn) btn.classList.add('active');
            }
            
            // Highlight view buttons
            const viewBtn = document.querySelector(`[data-view="${viewName}"]`);
            if (viewBtn) viewBtn.classList.add('active');

            localStorage.setItem('mechanic.activeView', viewName);
            
            // Auto-refresh data for specific views
            if (viewName === 'libraries') refreshLibraries();
            if (viewName === 'settings') refreshSettings();
            if (viewName === 'sandbox') refreshSandboxStubs();
        }

        function navigateToCommand(cmd) {
            currentCommand = cmd;
            cmdName.textContent = cmd;
            cmdDesc.textContent = commandDescriptions[cmd] || 'No description available.';
            consoleCmd.value = cmd;
            
            const defaults = commandDefaults[cmd] || {};
            consoleInput.value = JSON.stringify({addon: selectedAddon, ...defaults});
            
            showView('command');
            displayCurrentResult();
            localStorage.setItem('mechanic.activeCommand', cmd);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LIBRARY MANAGER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function refreshLibraries() {
            if (!selectedAddon) {
                document.getElementById('lib-table-body').innerHTML = 
                    '<tr><td colspan="4" style="text-align: center; color: var(--text-dim); padding: 2rem;">Select an addon first</td></tr>';
                return;
            }
            
            document.getElementById('lib-table-body').innerHTML = 
                '<tr><td colspan="4" style="text-align: center; color: var(--text-dim); padding: 2rem;">Loading...</td></tr>';
            
            const result = await executeCommand('libs.check', { addon: selectedAddon });
            
            if (!result.success) {
                document.getElementById('lib-table-body').innerHTML = 
                    `<tr><td colspan="4" style="text-align: center; color: var(--error); padding: 2rem;">${result.error?.message || 'Failed to check libraries'}</td></tr>`;
                return;
            }
            
            const data = result.data;
            
            // Update config banner
            const banner = document.getElementById('lib-config-banner');
            if (data.has_config) {
                banner.className = 'lib-config-status found';
                banner.innerHTML = `<span>‚úÖ</span><span><code>libs.json</code> found with ${data.configured_count || 0} libraries configured (mode: ${data.mode || 'include'})</span>`;
            } else {
                banner.className = 'lib-config-status missing';
                banner.innerHTML = `<span>‚ö†Ô∏è</span><span>No <code>libs.json</code> found. <a href="#" id="btn-lib-init" style="color: var(--primary)">Initialize config</a> to manage libraries.</span>`;
                document.getElementById('btn-lib-init')?.addEventListener('click', initLibsConfig);
            }
            
            // Update stats
            const libs = data.libraries || [];
            const okCount = libs.filter(l => l.status === 'ok').length;
            const missingCount = libs.filter(l => l.status === 'missing').length;
            const extraCount = libs.filter(l => l.status === 'extra').length;
            
            document.getElementById('lib-stat-ok').textContent = okCount;
            document.getElementById('lib-stat-missing').textContent = missingCount;
            document.getElementById('lib-stat-extra').textContent = extraCount;
            
            // Update table
            if (libs.length === 0) {
                document.getElementById('lib-table-body').innerHTML = 
                    '<tr><td colspan="4" style="text-align: center; color: var(--text-dim); padding: 2rem;">No libraries found</td></tr>';
                return;
            }
            
            // Sort: missing first, then extra, then ok
            libs.sort((a, b) => {
                const order = { missing: 0, extra: 1, ok: 2 };
                return (order[a.status] ?? 3) - (order[b.status] ?? 3);
            });
            
            document.getElementById('lib-table-body').innerHTML = libs.map(lib => {
                const statusClass = lib.status === 'ok' ? 'ok' : (lib.status === 'missing' ? 'missing' : 'extra');
                const isLocal = lib.configured_version === 'local';
                const badgeClass = isLocal ? 'local' : statusClass;
                const statusText = isLocal ? 'local' : lib.status;
                
                return `<tr>
                    <td><span class="lib-name">${lib.name || lib.library}</span></td>
                    <td><span class="lib-version">${lib.configured_version || '‚Äî'}</span></td>
                    <td><span class="lib-version">${lib.installed_version || '‚Äî'}</span></td>
                    <td><span class="lib-badge ${badgeClass}">${statusText}</span></td>
                </tr>`;
            }).join('');
        }
        
        async function initLibsConfig(e) {
            if (e) e.preventDefault();
            if (!selectedAddon) return;
            
            const result = await executeCommand('libs.init', { addon: selectedAddon });
            if (result.success) {
                showToast('Config Created', `libs.json created with ${result.data?.library_count || 0} libraries`, 'success');
                refreshLibraries();
            } else {
                showToast('Error', result.error?.message || 'Failed to create config', 'error');
            }
        }
        
        async function syncLibraries(force = false) {
            if (!selectedAddon) return;
            
            const result = await executeCommand('libs.sync', { addon: selectedAddon, force });
            if (result.success) {
                const data = result.data || {};
                const copied = data.copied || 0;
                const updated = data.updated || 0;
                const skipped = data.skipped || 0;
                const errors = data.errors || 0;
                
                let message = [];
                if (copied > 0) message.push(`${copied} copied`);
                if (updated > 0) message.push(`${updated} updated`);
                if (skipped > 0) message.push(`${skipped} skipped`);
                if (errors > 0) message.push(`${errors} errors`);
                
                showToast('Sync Complete', message.join(', ') || 'No changes', errors > 0 ? 'warning' : 'success');
                refreshLibraries();
            } else {
                showToast('Sync Failed', result.error?.message || 'Failed to sync libraries', 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SETTINGS VIEW
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function refreshSettings() {
            // Get environment status
            const result = await executeCommand('env.status', {});
            
            if (result.success && result.data) {
                const data = result.data;
                
                // WoW paths
                document.getElementById('settings-wow-root').textContent = data.wow_root ? '‚úì Found' : '‚úó Not found';
                document.getElementById('settings-wow-root').className = 'value ' + (data.wow_root ? 'success' : 'error');
                document.getElementById('settings-dev-path').textContent = data.dev_path ? '‚úì Found' : '‚úó Not found';
                document.getElementById('settings-dev-path').className = 'value ' + (data.dev_path ? 'success' : 'error');
                document.getElementById('settings-wow-path-full').textContent = data.wow_root || 'Not configured';
                
                // Flavors
                const flavors = data.flavors || [];
                document.getElementById('settings-flavors').innerHTML = flavors.length > 0 
                    ? flavors.map(f => `<span class="flavor-badge ${f.exists ? 'active' : 'inactive'}">${f.exists ? '‚úì' : '‚úó'} ${f.name}</span>`).join('')
                    : '<span class="flavor-badge inactive">No clients detected</span>';
                
                // Data directory
                document.getElementById('settings-data-dir').textContent = data.data_dir || '~/.mechanic';
            }
            
            // Get tool status
            const toolResult = await executeCommand('tools.status', {});
            
            if (toolResult.success && toolResult.data) {
                // Tools are returned as an array, convert to lookup by name
                const toolsArray = toolResult.data.tools || [];
                const toolsByName = {};
                toolsArray.forEach(t => { toolsByName[t.name] = t; });
                
                const updateTool = (id, tool) => {
                    const el = document.getElementById(id);
                    if (tool?.installed) {
                        el.textContent = tool.version || '‚úì Found';
                        el.className = 'value success';
                    } else {
                        el.textContent = '‚úó Not found';
                        el.className = 'value error';
                    }
                };
                
                updateTool('settings-luacheck', toolsByName.luacheck);
                updateTool('settings-stylua', toolsByName.stylua);
                updateTool('settings-lua', toolsByName.lua);
                updateTool('settings-busted', toolsByName.busted);
            }
            
            // Populate addon list
            const addonListEl = document.getElementById('settings-addon-list');
            const addonNames = Object.keys(knownAddons);
            if (addonNames.length > 0) {
                addonListEl.innerHTML = addonNames.map(name => `
                    <div class="addon-list-item" data-addon="${name}">
                        <div>
                            <div class="addon-name">${name}</div>
                            <div class="addon-path" title="${knownAddons[name]}">${knownAddons[name]}</div>
                        </div>
                        <button class="btn-remove" onclick="removeAddon('${name}')" title="Remove addon">üóëÔ∏è</button>
                    </div>
                `).join('');
            } else {
                addonListEl.innerHTML = '<div class="addon-list-empty">No addons registered. Click + in the sidebar to add one.</div>';
            }
        }
        
        // Remove addon function
        async function removeAddon(addonName) {
            if (!confirm(`Remove "${addonName}" from registered addons?`)) return;
            
            const result = await executeCommand('addon.remove', { addon: addonName });
            if (result.success) {
                delete knownAddons[addonName];
                populateAddonSelector();
                refreshSettings();
                showToast('Addon Removed', `${addonName} has been removed`, 'success');
            } else {
                showToast('Error', result.error?.message || 'Failed to remove addon', 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMMAND HISTORY
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function addToHistory(cmd, result) {
            if (!commandHistory[cmd]) commandHistory[cmd] = [];
            commandHistory[cmd].push({
                result,
                timestamp: new Date().toISOString()
            });
            historyIndex[cmd] = commandHistory[cmd].length - 1;
        }

        function displayCurrentResult() {
            if (!currentCommand) return;
            
            const history = commandHistory[currentCommand] || [];
            const idx = historyIndex[currentCommand] ?? -1;
            
            if (history.length === 0 || idx < 0) {
                cmdNoResult.style.display = 'block';
                cmdResult.style.display = 'none';
                cmdStatus.textContent = '‚Äî';
                cmdTime.textContent = '‚Äî';
                historyInfo.textContent = 'No runs';
                btnPrev.disabled = true;
                btnNext.disabled = true;
                return;
            }
            
            cmdNoResult.style.display = 'none';
            cmdResult.style.display = 'block';
            
            const entry = history[idx];
            const result = entry.result;
            
            // Status
            cmdStatus.textContent = result.success ? '‚úì Success' : '‚úó Error';
            cmdStatus.className = 'result-status ' + (result.success ? 'success' : 'error');
            cmdTime.textContent = new Date(entry.timestamp).toLocaleTimeString();
            
            // History nav
            historyInfo.textContent = `${idx + 1} / ${history.length}`;
            btnPrev.disabled = idx <= 0;
            btnNext.disabled = idx >= history.length - 1;
            
            // Reasoning
            document.getElementById('result-reasoning').textContent = result.reasoning || result.error?.message || '‚Äî';
            
            // Confidence
            const pct = result.confidence != null ? Math.round(result.confidence * 100) : 0;
            document.getElementById('confidence-fill').style.width = `${pct}%`;
            document.getElementById('confidence-text').textContent = result.confidence != null ? `${pct}%` : '‚Äî';
            
            // Sources
            const sourceList = document.getElementById('source-list');
            if (result.sources && result.sources.length > 0) {
                sourceList.innerHTML = result.sources.map(s => 
                    `<li class="source-item"><span>üìÑ</span> ${s.title || s.location || s.id}</li>`
                ).join('');
            } else {
                sourceList.innerHTML = '<li class="source-item" style="color: var(--text-dim);">No sources</li>';
            }
            
            // Data
            document.getElementById('result-data').textContent = result.data 
                ? JSON.stringify(result.data, null, 2) 
                : (result.error ? JSON.stringify(result.error, null, 2) : '// No data');
        }

        // History navigation
        btnPrev.onclick = () => {
            if (!currentCommand || !commandHistory[currentCommand]) return;
            historyIndex[currentCommand] = Math.max(0, (historyIndex[currentCommand] ?? 0) - 1);
            displayCurrentResult();
        };
        
        btnNext.onclick = () => {
            if (!currentCommand || !commandHistory[currentCommand]) return;
            const max = commandHistory[currentCommand].length - 1;
            historyIndex[currentCommand] = Math.min(max, (historyIndex[currentCommand] ?? 0) + 1);
            displayCurrentResult();
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMMAND EXECUTION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function executeCommand(command, input = {}) {
            const finalInput = { addon: selectedAddon, ...input };
            
            try {
                const res = await fetch('/api/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command, input: finalInput })
                });
                const result = await res.json();
                
                addToHistory(command, result);
                consoleOutput.textContent = JSON.stringify(result, null, 2);
                
                // Update view if we're looking at this command
                if (currentCommand === command) {
                    displayCurrentResult();
                }
                
                return result;
            } catch (err) {
                consoleOutput.textContent = `Error: ${err.message}`;
                return { success: false, error: { message: err.message } };
            }
        }

        // Run button with loading state
        btnRunCmd.onclick = async () => {
            if (currentCommand && !btnRunCmd.classList.contains('loading')) {
                try {
                    // Read current input from the console box to capture defaults/edits
                    const input = JSON.parse(consoleInput.value.trim() || '{}');
                    
                    // Show loading state (keeps "‚ñ∂ Run" text)
                    btnRunCmd.classList.add('loading');
                    
                    await executeCommand(currentCommand, input);
                    
                    // Reset button
                    btnRunCmd.classList.remove('loading');
                } catch (e) {
                    showToast('Input Error', 'Invalid JSON in console input', 'error');
                    btnRunCmd.classList.remove('loading');
                }
            }
        };

        // Clear history button
        document.getElementById('btn-clear-history').onclick = () => {
            if (currentCommand && confirm(`Clear all history for ${currentCommand}?`)) {
                clearHistory(currentCommand);
            }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EVENT HANDLERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Mechanic tab
        mechanicTab.onclick = () => showView('mechanic');
        
        // Sandbox tab
        sandboxTab.onclick = () => showView('sandbox');
        
        // Command buttons (navigation only) and view buttons
        document.querySelectorAll('.cmd-btn').forEach(btn => {
            if (btn.dataset.view) {
                // View navigation button
                btn.onclick = () => showView(btn.dataset.view);
            } else if (btn.dataset.cmd) {
                // Command navigation button
                btn.onclick = () => navigateToCommand(btn.dataset.cmd);
            }
        });
        
        // Library Manager buttons
        document.getElementById('btn-lib-refresh').onclick = () => refreshLibraries();
        document.getElementById('btn-lib-sync').onclick = () => syncLibraries(false);
        document.getElementById('btn-lib-force-sync').onclick = () => syncLibraries(true);
        
        // Settings buttons
        document.getElementById('btn-settings-refresh').onclick = () => refreshSettings();
        document.getElementById('btn-settings-add-addon').onclick = () => addAddon().then(() => refreshSettings());

        // Addon selector
        addonSelect.onchange = () => {
            selectedAddon = addonSelect.value;
            localStorage.setItem('mechanic.selectedAddon', selectedAddon);
            updateAddonStatus();
        };

        // Header buttons
        document.getElementById('btn-create-nav').onclick = () => navigateToCommand('addon.create');
        document.getElementById('btn-reload').onclick = () => executeCommand('reload.trigger', {});  // Uses default CTRL+SHIFT+R
        document.getElementById('btn-stop').onclick = () => {
            if (confirm('Stop the Mechanic server?')) executeCommand('server.shutdown');
        };
        document.getElementById('btn-settings').onclick = () => showView('settings');
        
        // Sandbox buttons
        document.getElementById('btn-sandbox-run').onclick = () => runSandboxTests();
        document.getElementById('btn-sandbox-generate').onclick = () => generateSandboxStubs();
        
        // Get Started overlay buttons
        document.getElementById('btn-get-started').onclick = () => document.getElementById('btn-add-addon').click();
        
        // Add Addon Button
        document.getElementById('btn-add-addon').onclick = async () => {
             try {
                const res = await executeCommand('system.pick_file', {
                    title: 'Select Addon TOC File',
                    filter: 'WoW Addon TOC (*.toc)|*.toc'
                });
                
                if (res.success && res.data) {
                    const fullPath = res.data.directory;
                    const tocName = res.data.filename; // e.g., "MyAddon.toc"
                    const addonName = tocName.replace('.toc', '');
                    
                    // Save to known addons
                    knownAddons[addonName] = fullPath;
                    localStorage.setItem('mechanic.addons', JSON.stringify(knownAddons));
                    
                    // Select it
                    selectedAddon = addonName;
                    localStorage.setItem('mechanic.selectedAddon', addonName);
                    
                    updateAddonList();
                    showToast('Addon Added', `Registered ${addonName}`, 'success');
                }
             } catch (e) {
                 showToast('Error', 'Failed to pick file', 'error');
             }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SANDBOX LOGIC
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function refreshSandboxStubs() {
            const statusEl = document.getElementById('sandbox-stubs-status');
            const totalEl = document.getElementById('sandbox-stubs-total');
            const protectedEl = document.getElementById('sandbox-stubs-protected');
            const normalEl = document.getElementById('sandbox-stubs-normal');

            // Fetch actual status from sandbox.status command
            const result = await executeCommand('sandbox.status', {});

            if (result.success && result.data) {
                const data = result.data;
                if (data.stubs_exist) {
                    statusEl.textContent = 'Ready';
                    statusEl.className = 'value success';
                    totalEl.textContent = data.stubs_generated || '‚Äî';
                    protectedEl.textContent = data.protected_count || '‚Äî';
                    normalEl.textContent = data.normal_count || '‚Äî';
                } else {
                    statusEl.textContent = 'Not Generated';
                    statusEl.className = 'value warning';
                    totalEl.textContent = '‚Äî';
                    protectedEl.textContent = '‚Äî';
                    normalEl.textContent = '‚Äî';
                }
            } else {
                statusEl.textContent = 'Error';
                statusEl.className = 'value error';
            }
        }

        async function generateSandboxStubs() {
            const btn = document.getElementById('btn-sandbox-generate');
            const statusEl = document.getElementById('sandbox-stubs-status');
            const totalEl = document.getElementById('sandbox-stubs-total');
            const protectedEl = document.getElementById('sandbox-stubs-protected');
            const normalEl = document.getElementById('sandbox-stubs-normal');

            btn.classList.add('loading');
            statusEl.textContent = 'Generating...';
            statusEl.className = 'value warning';

            const result = await executeCommand('sandbox.generate', {});

            if (result.success) {
                showToast('Stubs Generated', result.reasoning, 'success');
                const data = result.data || {};
                statusEl.textContent = 'Ready';
                statusEl.className = 'value success';
                totalEl.textContent = data.stubs_generated || '‚Äî';
                protectedEl.textContent = data.protected_count || '‚Äî';
                normalEl.textContent = data.normal_count || '‚Äî';
            } else {
                showToast('Generation Failed', result.error?.message || 'Unknown error', 'error');
                statusEl.textContent = 'Error';
                statusEl.className = 'value error';
            }

            btn.classList.remove('loading');
        }

        async function runSandboxTests() {
            if (!selectedAddon) {
                showToast('No Addon', 'Select an addon in the sidebar first', 'error');
                return;
            }
            
            const btn = document.getElementById('btn-sandbox-run');
            const resultsEl = document.getElementById('sandbox-results');
            
            btn.classList.add('loading');
            btn.textContent = 'Running...';
            
            resultsEl.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-dim);">Running sandbox tests...</div>';
            
            const result = await executeCommand('sandbox.test', { addon: selectedAddon });
            
            if (result.success) {
                renderSandboxResults(result.data);
                showToast('Tests Complete', `${result.data.passed_count} passed, ${result.data.failed_count} failed`, result.data.passed ? 'success' : 'error');
            } else {
                resultsEl.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--error);">${result.error?.message || 'Failed to run tests'}</div>`;
                showToast('Test Failed', result.error?.message || 'Unknown error', 'error');
            }
            
            btn.classList.remove('loading');
            btn.textContent = '‚ñ∂ Run Tests';
        }

        function renderSandboxResults(data) {
            document.getElementById('sandbox-passed').textContent = data.passed_count;
            document.getElementById('sandbox-failed').textContent = data.failed_count;
            document.getElementById('sandbox-addon').textContent = data.addon;

            // Enhanced summary with duration
            const duration = data.duration_ms ? ` in ${data.duration_ms.toFixed(0)}ms` : '';
            document.getElementById('sandbox-summary').textContent = `${data.passed_count} / ${data.total} passed${duration}`;

            const resultsEl = document.getElementById('sandbox-results');

            if (!data.tests || data.tests.length === 0) {
                resultsEl.innerHTML = '<div style="padding: 1rem; color: var(--text-dim); text-align: center;">No tests found for this addon.</div>';
                return;
            }

            // Group tests by describe block (part before " > ")
            const groups = {};
            data.tests.forEach(test => {
                const parts = test.name.split(' > ');
                const group = parts.length > 1 ? parts[0] : 'Tests';
                const testName = parts.length > 1 ? parts.slice(1).join(' > ') : test.name;
                if (!groups[group]) groups[group] = [];
                groups[group].push({ ...test, shortName: testName });
            });

            // Build grouped test list
            let testList = '';
            for (const [groupName, tests] of Object.entries(groups)) {
                const groupPassed = tests.filter(t => t.passed).length;
                const groupTotal = tests.length;
                const groupStatus = groupPassed === groupTotal ? 'pass' : 'fail';

                testList += `
                    <div class="test-group" style="margin-bottom: 0.75rem;">
                        <div class="test-group-header" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); margin-bottom: 0.25rem;">
                            <span class="test-status-bullet ${groupStatus}"></span>
                            <span style="font-weight: 600; color: var(--text);">${groupName}</span>
                            <span style="color: var(--text-dim); font-size: 0.8rem; margin-left: auto;">${groupPassed}/${groupTotal}</span>
                        </div>
                        <div class="test-group-items" style="padding-left: 1.25rem;">
                `;

                tests.forEach(test => {
                    const durationStr = test.duration ? `<span style="color: var(--text-dim); font-size: 0.75rem; margin-left: auto;">${test.duration.toFixed(1)}ms</span>` : '';
                    const errorStr = !test.passed && test.error ? `<div style="color: var(--error); font-size: 0.75rem; padding: 0.25rem 0 0.25rem 1.25rem; opacity: 0.9;">${test.error}</div>` : '';

                    testList += `
                        <div class="test-row no-click" style="padding: 0.25rem 0;">
                            <div class="test-info" style="display: flex; align-items: center; gap: 0.5rem;">
                                <div class="test-status-bullet ${test.passed ? 'pass' : 'fail'}"></div>
                                <div class="test-name" style="color: ${test.passed ? 'var(--text-dim)' : 'var(--text)'};">${test.shortName}</div>
                                ${durationStr}
                            </div>
                            ${errorStr}
                        </div>
                    `;
                });

                testList += `</div></div>`;
            }

            // Build metadata section
            const sourceFiles = data.source_files?.length ? data.source_files.join(', ') : 'None';
            const specFiles = data.spec_files?.length ? data.spec_files.map(f => f.split('/').pop()).join(', ') : 'None';

            const metadata = `
                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-dark); border-radius: 4px; font-size: 0.8rem; color: var(--text-dim);">
                    <div style="margin-bottom: 0.25rem;"><strong>Source:</strong> ${sourceFiles}</div>
                    <div><strong>Specs:</strong> ${specFiles}</div>
                </div>
            `;

            resultsEl.innerHTML = testList + metadata;
        }


        // Console
        document.getElementById('btn-execute').onclick = async () => {
            const cmd = consoleCmd.value.trim();
            try {
                const input = JSON.parse(consoleInput.value.trim() || '{}');
                await executeCommand(cmd, input);
            } catch (err) {
                consoleOutput.textContent = `Parse error: ${err.message}`;
            }
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            switch(e.key.toLowerCase()) {
                case 'r': executeCommand('reload.trigger', {}); break;  // Uses default CTRL+SHIFT+R
                case 'v': navigateToCommand('addon.validate'); break;
                case ':': e.preventDefault(); consoleCmd.focus(); break;
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ADDON OUTPUT PANE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // State for output pane
        let outputData = { errors: [], tests: [], console: [], timestamp: null };
        let consoleFilter = 'all';
        
        // Toggle section collapse
        function toggleSection(section) {
            const body = document.getElementById(`output-${section}-body`);
            body.classList.toggle('collapsed');
        }
        
        // Fetch and render addon output
        async function fetchAddonOutput() {
            try {
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: 'addon.output', input: {} })
                });
                const result = await response.json();
                if (result.success && result.data) {
                    // Parse the data from the result
                    updateOutputPane(result.data);
                }
            } catch (e) {
                console.log('Failed to fetch addon output:', e);
            }
        }
        
        // Update the output pane from WebSocket msg or API result
        function updateOutputPane(data) {
            // Update header meta
            document.getElementById('output-reload-time').textContent = data.timestamp || new Date().toLocaleTimeString();
            // Removed addon name display as requested
            
            // Update stats
            document.getElementById('output-error-count').textContent = data.error_count || 0;
            document.getElementById('output-console-count').textContent = data.console_count || 0;
            
            // Store for rendering
            outputData = data;
            
            // Render sections from WebSocket data if available
            if (data.libraries) renderLibraryTags(data.libraries);
            if (data.errors) renderErrorTree(data.errors);
            if (data.tests) renderTestBadges(data.tests, data.perf);
            if (data.console) renderConsoleLog(data.console);
        }
        
        // Render library version badges
        function renderLibraryTags(libraries) {
            const container = document.getElementById('output-libraries-row');
            
            if (!libraries || libraries.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            
            // Highlight important libraries
            const highlights = ['FenUI', 'MechanicLib', 'AceAddon-3.0'];
            
            container.innerHTML = libraries.map(lib => {
                const isHighlight = highlights.some(h => lib.name.includes(h));
                const cls = isHighlight ? 'lib-badge-small highlight' : 'lib-badge-small';
                return `<div class="${cls}" title="${lib.name}">${lib.name} ${lib.version}</div>`;
            }).join('');
        }
        
        // Handle WebSocket messages for real-time updates
        function updateTestResults(msg) {
            // Update header
            document.getElementById('output-reload-time').textContent = new Date().toLocaleTimeString();
            // Removed addon name display as requested
            
            const tests = msg.data?.tests || [];
            const passed = tests.filter(t => t.passed).length;
            
            // Update test count
            document.getElementById('output-test-count').textContent = `${passed}/${tests.length}`;
            
            // Render test badges
            renderTestBadges(tests, msg.data?.perf);
            
            // Fetch full output to get errors and console
            fetchAddonOutput();
        }
        
        // Render error tree grouped by addon
        function renderErrorTree(errors) {
            const container = document.getElementById('output-error-tree');
            
            if (!errors || errors.length === 0) {
                container.innerHTML = '<div style="padding: 1rem; color: var(--text-dim); text-align: center;">No errors. Do /reload in-game to capture data.</div>';
                return;
            }
            
            // Group by addon
            const byAddon = {};
            for (const err of errors) {
                const addon = err.addon || 'Unknown';
                if (!byAddon[addon]) byAddon[addon] = [];
                byAddon[addon].push(err);
            }
            
            // Sort addons alphabetically
            const sortedAddons = Object.keys(byAddon).sort();
            
            let html = '';
            for (const addon of sortedAddons) {
                const addonErrors = byAddon[addon];
                const count = addonErrors.reduce((sum, e) => sum + (e.counter || 1), 0);
                
                html += `
                    <div class="error-addon">
                        <div class="error-addon-header" onclick="toggleAddonErrors('${addon}')">
                            <div class="error-addon-name" id="addon-name-${addon}">
                                <span class="chevron">‚ñ∂</span> ${addon}
                            </div>
                            <span class="error-addon-count">${count}</span>
                        </div>
                        <div id="addon-errors-${addon}" class="error-addon-items">
                `;
                
                for (let i = 0; i < Math.min(addonErrors.length, 10); i++) {
                    const err = addonErrors[i];
                    const location = `${err.file || 'unknown'}:${err.line || 0}`;
                    const countStr = (err.counter || 1) > 1 ? `<span class="error-count">√ó${err.counter}</span>` : '';
                    const msg = extractErrorMessage(err.message);
                    const errId = `err-${addon}-${i}`;
                    
                    html += `
                        <div class="error-item" onclick="toggleErrorDetail('${errId}')">
                            <span class="error-location">${location}</span>${countStr}
                            <span class="error-message">${msg}</span>
                        </div>
                        <div id="${errId}" class="error-detail">${err.stack || err.message || 'No details'}</div>
                    `;
                }
                
                if (addonErrors.length > 10) {
                    html += `<div class="error-item" style="color: var(--text-dim);">... and ${addonErrors.length - 10} more</div>`;
                }
                
                html += '</div></div>';
            }
            
            container.innerHTML = html;
        }
        
        // Extract clean error message
        function extractErrorMessage(msg) {
            if (!msg) return '';
            const parts = msg.split(':');
            if (parts.length > 3) return parts.slice(3).join(':').trim().substring(0, 80);
            return msg.substring(0, 80);
        }
        
        // Toggle addon errors visibility
        function toggleAddonErrors(addon) {
            const items = document.getElementById(`addon-errors-${addon}`);
            const name = document.getElementById(`addon-name-${addon}`);
            if (items) items.classList.toggle('expanded');
            if (name) name.classList.toggle('expanded');
        }
        
        // Toggle error detail visibility
        function toggleErrorDetail(errId) {
            const detail = document.getElementById(errId);
            if (detail) detail.classList.toggle('expanded');
        }
        function renderTestBadges(tests, perfData = {}) {
            const container = document.getElementById('output-addon-tests-container');
            if (!container) return;
            
            if (!tests || tests.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            // Group by Addon -> Category
            const grouped = {};
            for (const t of tests) {
                const addon = t.addon || '!Mechanic';
                const cat = t.category || 'General';
                if (!grouped[addon]) grouped[addon] = {};
                if (!grouped[addon][cat]) grouped[addon][cat] = [];
                grouped[addon][cat].push(t);
            }
            
            let html = '';
            const addons = Object.keys(grouped).sort();
            
            for (const addon of addons) {
                const addonTests = tests.filter(t => t.addon === addon);
                const addonPassed = addonTests.filter(t => t.passed).length;
                const addonPerf = (perfData && perfData[addon]) || [];
                const perfId = `perf-${addon}`.replace(/\s+/g, '-');
                const sectionId = `section-tests-${addon}`.replace(/\s+/g, '-');

                html += `
                    <div class="output-section">
                        <div class="output-section-header" onclick="toggleSection('${sectionId}')">
                            <div class="output-section-title">
                                ‚úÖ TESTS: ${addon}
                                <span style="font-weight: normal; opacity: 0.6; font-size: 0.75rem; margin-left: 0.5rem;">
                                    ${addonPassed}/${addonTests.length} Passed
                                </span>
                            </div>
                            <div class="output-section-meta">‚ñº</div>
                        </div>
                        <div id="output-${sectionId}-body" class="output-section-body">
                            <div class="test-tree">
                                <!-- Addon Performance Sub-Section (Optional) -->
                                ${addonPerf.length > 0 ? `
                                    <div class="test-addon-perf-row" onclick="togglePerfDetail('${perfId}')">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--primary);">
                                            <span>üõ°Ô∏è</span> SYSTEM HEALTH
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="font-size: 0.65rem; opacity: 0.7;">${addonPerf.length} Metrics</span>
                                            <span class="test-chevron-perf">‚ñ∂</span>
                                        </div>
                                    </div>
                                    <div id="${perfId}" class="test-details-pane-perf">
                                        ${addonPerf.map(p => `
                                            <div class="test-detail-item" style="justify-content: space-between;">
                                                <div><span>‚ö°</span> ${p.name} <span style="font-size: 0.9em; opacity: 0.7;">(${p.description})</span></div>
                                                <div style="color: var(--text); font-weight: 600;">${p.ms != null ? p.ms : ''}${p.percent != null ? ' (' + p.percent + '%)' : ''}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                `;
                
                const cats = Object.keys(grouped[addon]).sort();
                for (const cat of cats) {
                    html += `
                        <div class="test-category">
                            <div class="test-category-header">${cat}</div>
                    `;
                    
                    for (let i = 0; i < grouped[addon][cat].length; i++) {
                        const t = grouped[addon][cat][i];
                        const testId = `test-${addon}-${cat}-${i}`.replace(/\s+/g, '-');
                        const statusClass = t.passed ? 'pass' : 'fail';
                        const duration = t.duration ? `${(t.duration * 1000).toFixed(1)}ms` : '';
                        
                        // Check if we have any useful data to show in a detail pane
                        const hasDetails = t.message || (t.details && Object.keys(t.details).length > 0) || (t.logs && t.logs.length > 0);
                        const rowCls = hasDetails ? 'test-row' : 'test-row no-click';

                        html += `
                            <div class="${rowCls}" ${hasDetails ? `onclick="toggleTestDetail('${testId}')"` : ''} id="row-${testId}">
                                <div class="test-info">
                                    <div class="test-status-bullet ${statusClass}"></div>
                                    <span class="test-name">${t.name || 'unnamed'}</span>
                                    <span class="test-meta">${duration}</span>
                                </div>
                                ${hasDetails ? '<span class="test-chevron">‚ñ∂</span>' : ''}
                            </div>
                            ${hasDetails ? `
                                <div id="${testId}" class="test-details-pane">
                                    ${t.message ? `<div class="test-msg">${t.message}</div>` : ''}
                                    
                                    ${t.details && Object.keys(t.details).length > 0 ? `
                                        <span class="test-label-small">Steps / Details</span>
                                        ${Object.values(t.details).map(d => {
                                            if (typeof d === 'string') return `<div class="test-detail-item"><span>‚Ä¢</span> ${d}</div>`;
                                            
                                            // Handle structured step objects (common in Flightsim/DIAG)
                                            if (typeof d === 'object' && d !== null) {
                                                const label = d.label || d.msg || d.text || '';
                                                const value = d.value !== undefined ? `: <span style="color: var(--text); font-weight: 500;">${d.value}</span>` : '';
                                                const status = d.status ? ` <span style="font-size: 0.8em; opacity: 0.6;">(${d.status})</span>` : '';
                                                
                                                if (label || value) {
                                                    return `<div class="test-detail-item"><span>‚Ä¢</span> ${label}${value}${status}</div>`;
                                                }
                                                return `<div class="test-detail-item"><span>‚Ä¢</span> ${JSON.stringify(d)}</div>`;
                                            }
                                            return `<div class="test-detail-item"><span>‚Ä¢</span> ${d}</div>`;
                                        }).join('')}
                                    ` : ''}
                                    
                                    ${t.logs && t.logs.length > 0 ? `
                                        <span class="test-label-small" style="margin-top: 0.75rem;">Captured Logs</span>
                                        <div class="test-captured-logs">${t.logs.join('\n')}</div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        `;
                    }
                    html += `</div>`; // end category
                }
                html += `</div></div></div>`; // end body, section
            }
            
            container.innerHTML = html;
        }

        // Toggle test detail pane
        function toggleTestDetail(testId) {
            const pane = document.getElementById(testId);
            const row = document.getElementById(`row-${testId}`);
            if (pane) pane.classList.toggle('expanded');
            if (row) row.classList.toggle('expanded');
        }

        // Toggle performance detail pane
        function togglePerfDetail(perfId) {
            const pane = document.getElementById(perfId);
            if (pane) pane.classList.toggle('expanded');
            // Find the chevron in the header above
            const header = pane.previousElementSibling;
            const chevron = header.querySelector('.test-chevron-perf');
            if (chevron) {
                const isExpanded = pane.classList.contains('expanded');
                chevron.style.transform = isExpanded ? 'rotate(90deg)' : 'rotate(0deg)';
            }
        }
        
        // Render console log
        function renderConsoleLog(entries) {
            const container = document.getElementById('output-console-entries');
            
            if (!entries || entries.length === 0) {
                container.innerHTML = '<div style="padding: 0.5rem 0.75rem; color: var(--text-dim);">No console entries. Do /reload in-game to capture logs.</div>';
                return;
            }
            
            // Filter entries
            const filtered = consoleFilter === 'all' 
                ? entries 
                : entries.filter(e => e.category === consoleFilter || e.source === consoleFilter);
            
            let html = '';
            
            // Sequence deduplication for display
            const deduped = [];
            let currentKey = null;
            let currentEntry = null;
            let count = 0;
            
            for (const entry of filtered.slice(-50)) {
                const key = `${entry.source}|${entry.category}|${entry.message}`;
                if (currentKey === null) {
                    currentKey = key;
                    currentEntry = entry;
                    count = 1;
                } else if (key === currentKey) {
                    count++;
                } else {
                    deduped.push({ ...currentEntry, count });
                    currentKey = key;
                    currentEntry = entry;
                    count = 1;
                }
            }
            if (currentEntry) deduped.push({ ...currentEntry, count });

            for (const entry of deduped) {
                const source = entry.source || 'System';
                const category = entry.category ? `[${entry.category}]` : '';
                const message = entry.message || '';
                const countStr = entry.count > 1 ? ` <span style="color: var(--text-dim); font-size: 0.825em; font-weight: normal; margin-left: 0.25rem;">(x${entry.count})</span>` : '';
                html += `<div class="console-entry"><span class="console-source">[${source}]</span><span class="console-category">${category}</span><span class="console-message">${message}${countStr}</span></div>`;
            }
            
            container.innerHTML = html;
            document.getElementById('output-console-count').textContent = entries.length;
        }
        
        // Console filter click handler
        document.querySelectorAll('.console-filter').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.console-filter').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                consoleFilter = btn.dataset.filter;
                if (outputData.console) renderConsoleLog(outputData.console);
            });
        });
        
        // Copy all output for AI
        document.getElementById('btn-copy-output')?.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: 'addon.output', input: { agent_mode: true } })
                });
                const result = await response.json();
                if (result.success && result.data?.output) {
                    await navigator.clipboard.writeText(result.data.output);
                    showToast('Copied!', 'Agent-optimized output copied to clipboard', 'success');
                }
            } catch (e) {
                showToast('Error', 'Failed to copy output', 'error');
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INITIALIZATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function init() {
            // Uptime
            setInterval(() => {
                const seconds = Math.floor((Date.now() - startTime) / 1000);
                const mins = Math.floor(seconds / 60);
                uptimeEl.textContent = mins > 0 ? `${mins}m ${seconds % 60}s` : `${seconds}s`;
            }, 1000);
            
            // Load accounts
            const result = await executeCommand('sv.discover', {});
            if (result.success && result.data?.paths) {
                const accounts = result.data.paths.map(path => {
                    const parts = path.split(/[/\\]/);
                    const flavor = parts.find(p => p.startsWith('_') && p.endsWith('_')) || '';
                    const account = parts[parts.length - 2] || 'Unknown';
                    return `${account} (${flavor.replace(/_/g, '')})`;
                });
                accountsInfo.textContent = `Accounts: ${accounts.join(', ')}`;
            }
            
            // Check tool status
            try {
                const toolResult = await executeCommand('tools.status', {});
                if (toolResult.success && toolResult.data?.required_missing > 0) {
                    document.getElementById('tool-banner').style.display = 'flex';
                }
            } catch (e) {}
            
            // Load persisted command history
            await loadHistory();
            
            // Restore persistent UI state
            const lastView = localStorage.getItem('mechanic.activeView') || 'mechanic';
            const lastCommand = localStorage.getItem('mechanic.activeCommand');
            const lastAddon = localStorage.getItem('mechanic.selectedAddon');

            if (lastAddon) {
                selectedAddon = lastAddon;
            }
            updateAddonList();

            if (lastView === 'command' && lastCommand) {
                navigateToCommand(lastCommand);
            } else if (['mechanic', 'libraries', 'settings', 'sandbox'].includes(lastView)) {
                showView(lastView);
            } else {
                showView('mechanic');
            }
        }
        
        // Load history from database
        async function loadHistory() {
            try {
                const res = await fetch('/api/history?limit=100');
                const data = await res.json();
                if (data.history) {
                    // Group by command
                    for (const entry of data.history) {
                        const cmd = entry.command;
                        if (!commandHistory[cmd]) commandHistory[cmd] = [];
                        
                        // Check for duplicates before adding
                        const entryTime = new Date(entry.timestamp).getTime();
                        const isDuplicate = commandHistory[cmd].some(existing => 
                            new Date(existing.timestamp).getTime() === entryTime
                        );
                        
                        if (!isDuplicate) {
                            commandHistory[cmd].push({
                                result: entry.result,
                                timestamp: entry.timestamp
                            });
                        }
                    }
                    // Set index to latest for each command
                    for (const cmd in commandHistory) {
                        historyIndex[cmd] = commandHistory[cmd].length - 1;
                    }
                }
            } catch (e) {
                console.log('Failed to load history:', e);
            }
        }
        
        // Clear history
        async function clearHistory(command = null) {
            try {
                await fetch('/api/history/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });
                if (command) {
                    commandHistory[command] = [];
                    historyIndex[command] = -1;
                } else {
                    for (const cmd in commandHistory) {
                        commandHistory[cmd] = [];
                        historyIndex[cmd] = -1;
                    }
                }
                displayCurrentResult();
                showToast('History cleared', command || 'All commands', 'success');
            } catch (e) {
                console.log('Failed to clear history:', e);
            }
        }
        
        init();
    </script>
</body>
</html>
